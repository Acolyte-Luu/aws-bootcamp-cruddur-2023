#! /usr/bin/env bash
set -e # stop execution of script if anything fails
#use-container flag is for building the lambda in a containernot a custom image

FUNC_DIR="/workspace/aws-bootcamp-cruddur-2023/aws/lambdas/cruddur-messaging-stream"
TEMPLATE_PATH="/workspace/aws-bootcamp-cruddur-2023/aws/cfn/dynamodb/template.yaml"
CONFIG_PATH="/workspace/aws-bootcamp-cruddur-2023/aws/cfn/dynamodb/config.toml"
ARTIFACT_BUCKET="cfn-artifacts-luu"

sam validate \
--template-file $TEMPLATE_PATH


sam build \
--use-container \
--config-file $CONFIG_PATH \
--template-file $TEMPLATE_PATH \
--base-dir $FUNC_DIR 
#--parameter-overrides \

TEMPLATE_PATH="/workspace/aws-bootcamp-cruddur-2023/.aws-sam/build/template.yaml"
OUTPUT_TEMPLATE_PATH="/workspace/aws-bootcamp-cruddur-2023/.aws-sam/build/packaged.yaml"


sam package \
--s3-bucket $ARTIFACT_BUCKET \
--config-file $CONFIG_PATH \
--output_template_file $OUTPUT_TEMPLATE_PATH \
--template-file $TEMPLATE_PATH \
--s3-prefix "dynamodb"

PACKAGED_TEMPLATE_PATH="/workspace/aws-bootcamp-cruddur-2023/.aws-sam/build/packaged.yaml"

sam deploy \
--template-file $PACKAGED_TEMPLATE_PATH \
--config-file $CONFIG_PATH \
--stack_name "CruddurDynamodb" \
--tags group=cruddur-dynamodb \
--capabilities "CAPABILITY_NAMED_IAM"